#!/usr/bin/env bash
set -e

echo "ğŸ” Running linting and formatting before push..."

# Try to use NVM's Node.js if available
if [ -s "$HOME/.nvm/nvm.sh" ]; then
  # Load NVM
  export NVM_DIR="$HOME/.nvm"
  \. "$NVM_DIR/nvm.sh" # This loads nvm
  
  # Use Node.js 20+ (|| true because nvm use failing is non-fatal; version check below is the gate)
  nvm use 20 >/dev/null 2>&1 || true
  
  echo "âœ… Using Node.js $(node -v) from NVM"
fi

# Require Node.js 20+ as specified in package.json
node_version=$(node -v | cut -d. -f1 | sed 's/v//')
if [ "$node_version" -lt 20 ]; then
  echo "âŒ Error: Node.js version $(node -v) is incompatible. This project requires Node.js 20.11.1+."
  echo "âŒ Push aborted. Please use Node.js 20+ for development."
  exit 1
fi

# Run linting with compatible Node.js version
pnpm fix-all

# Check adapter pattern compliance
echo "ğŸ” Checking adapter pattern compliance..."
pnpm lint:adapters

# Check if versions.ts needs updating
echo "ğŸ” Checking export versions synchronization..."
pnpm run update-export-versions

# Check if versions.ts was modified
if ! git diff --exit-code apps/builder/src/export/versions.ts; then
  echo "âš ï¸  Warning: versions.ts was updated. The file has been synchronized."
  echo "ğŸ“ Please add the updated versions.ts to your commit:"
  echo "   git add apps/builder/src/export/versions.ts"
  echo "   git commit --amend --no-edit"
  echo ""
  echo "âŒ Push aborted to allow you to include the version updates."
  exit 1
fi

echo "âœ… All checks passed!" 